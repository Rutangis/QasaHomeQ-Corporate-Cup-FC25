<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Participant Ratings</title>
    <style>
        /* Existing CSS styles... */
        /* [Omitted for brevity; ensure all previous styles are retained] */
    </style>
    <script>
        function confirmUpdate(formId) {
            if (confirm('Are you sure you want to update this rating?')) {
                document.getElementById(formId).submit();
            }
        }

        function confirmRemove(formId) {
            if (confirm('Are you sure you want to remove this participant/rater?')) {
                document.getElementById(formId).submit();
            }
        }

        function confirmGenerateTeams() {
            return confirm('Are you sure you want to generate teams? Existing team assignments will be overwritten.');
        }
    </script>
</head>
<body>
    <div class="content-container">
        <h1>Admin - Participant Ratings Overview</h1>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="flash-messages">
              {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                  {{ message }}
                </div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <div class="download-links">
            <a href="{{ url_for('download_participants') }}">Download Participants CSV</a>
            <a href="{{ url_for('download_ratings') }}">Download Ratings CSV</a>
        </div>

        <h2>Add New Participant</h2>
        <div class="add-participant-form">
            <form action="{{ url_for('admin_add_participant') }}" method="post">
                <input type="text" name="participant_name" placeholder="Enter participant name" required>
                <button type="submit" class="add-button">Add Participant</button>
            </form>
        </div>

        <h2>Participant Self-Ratings</h2>
        <table>
            <tr>
                <th style="width: 5%;">No.</th>
                <th style="width: 30%;">Name</th>
                <th style="width: 20%;">Rating</th>
                <th style="width: 15%;">Edit</th>
                <th style="width: 15%;">Remove</th>
            </tr>
            {% for participant in participants %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ participant['name'] }}</td>
                <td>
                    <form id="participant-update-rating-{{ loop.index }}" action="{{ url_for('admin_update_participant_rating') }}" method="post">
                        <input type="hidden" name="participant_name" value="{{ participant['name'] }}">
                        <input type="number" name="rating" value="{{ participant['rating'] }}" min="1" max="5" step="1" required>
                    </form>
                </td>
                <td>
                    <button type="button" onclick="confirmUpdate('participant-update-rating-{{ loop.index }}')">Update</button>
                </td>
                <td>
                    <form id="remove-participant-{{ loop.index }}" action="{{ url_for('admin_remove_participant') }}" method="post">
                        <input type="hidden" name="participant_name" value="{{ participant['name'] }}">
                        <button type="button" class="remove-button" onclick="confirmRemove('remove-participant-{{ loop.index }}')">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>

        <h2>Ratings Given By Participants</h2>
        <table>
            <tr>
                <th style="width: 5%;">No.</th>
                <th style="width: 20%;">Rater</th>
                <th style="width: 20%;">Rated Player</th>
                <th style="width: 10%;">Rating</th>
                <th style="width: 15%;">Edit</th>
                <th style="width: 15%;">Remove</th>
            </tr>
            {% for rating in ratings %}
            <tr>
                <td>{{ loop.index }}</td>
                <td>{{ rating['rater'] }}</td>
                <td>{{ rating['rated_player'] }}</td>
                <td>
                    <form id="rating-update-{{ loop.index }}" action="{{ url_for('admin_update_given_ratings') }}" method="post">
                        <input type="hidden" name="rater" value="{{ rating['rater'] }}">
                        <input type="hidden" name="rated_player" value="{{ rating['rated_player'] }}">
                        <input type="number" name="rating" value="{{ rating['rating'] }}" min="1" max="5" step="1" required>
                    </form>
                </td>
                <td>
                    <button type="button" onclick="confirmUpdate('rating-update-{{ loop.index }}')">Update</button>
                </td>
                <td>
                    <form id="remove-rating-{{ loop.index }}" action="{{ url_for('admin_remove_rating') }}" method="post">
                        <input type="hidden" name="rater" value="{{ rating['rater'] }}">
                        <input type="hidden" name="rated_player" value="{{ rating['rated_player'] }}">
                        <button type="button" class="remove-button" onclick="confirmRemove('remove-rating-{{ loop.index }}')">Remove</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </table>

        <!-- Team Assignment Section -->
        <div class="team-assignment">
            <h2>Team Assignments (Teams of 2)</h2>
            <form action="{{ url_for('admin') }}" method="get">
                <button type="submit" class="generate-teams-button" onclick="return confirmGenerateTeams()">Generate Teams</button>
            </form>

            {% if teams %}
                <table class="team-table">
                    <tr>
                        <th>Team No.</th>
                        <th>Members</th>
                        <th>Combined Average Rating</th>
                    </tr>
                    {% for team in teams %}
                    <tr>
                        <td>Team {{ loop.index }}</td>
                        <td>
                            <ul style="list-style-type: none; padding: 0; margin: 0;">
                                {% for member in team %}
                                <li>{{ member }}</li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td>
                            {% set total = 0 %}
                            {% for member in team %}
                                {% for stat in ratings_statistics %}
                                    {% if stat.name | lower == member | lower %}
                                        {% if stat.average != 'N/A' %}
                                            {% set total = total + stat.average | float %}
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                            {% if total > 0 %}
                                {{ "%.2f"|format(total) }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            {% endif %}
        </div>

        <!-- Logout Button -->
        <div style="text-align: center; margin-top: 20px;">
            <a href="{{ url_for('admin_logout') }}" class="remove-button" style="padding: 10px 20px; text-decoration: none;">Logout</a>
        </div>
    </div>
</body>
</html>
